<!DOCTYPE html>
<html lang="en-US">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=1db909fa1f06ea7ae5dc1a7973fa98b17f58e65a" media="screen" type="text/css">
    <link rel="stylesheet" href="/assets/css/print.css" media="print" type="text/css">
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FM | hahadsg’s note</title>
<meta name="generator" content="Jekyll v3.9.3">
<meta property="og:title" content="FM">
<meta property="og:locale" content="en_US">
<link rel="canonical" href="https://hahadsg.github.io/ComputationalAdvertising/CTR/FM.html">
<meta property="og:url" content="https://hahadsg.github.io/ComputationalAdvertising/CTR/FM.html">
<meta property="og:site_name" content="hahadsg’s note">
<meta property="og:type" content="article">
<meta property="article:published_time" content="">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="FM">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"","datePublished":"","headline":"FM","mainEntityOfPage":{"@type":"WebPage","@id":"https://hahadsg.github.io/ComputationalAdvertising/CTR/FM.html"},"url":"https://hahadsg.github.io/ComputationalAdvertising/CTR/FM.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <header>
      <div class="inner">
        <a href="https://hahadsg.github.io/">
          <h1>hahadsg's note</h1>
        </a>
        <h2></h2>
        
        
          <a href="https://github.com/hahadsg" class="button"><small>Follow me on</small> GitHub</a>
        
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h2 id="fmfactorization-machine">FM(Factorization Machine)</h2>

<p>FM是为了解决稀疏数据下的特征组合问题</p>

<p>假设一个分类问题（预测搜索广告场景下用户是否点击广告）</p>

<table>
  <thead>
    <tr>
      <th>Country</th>
      <th>Ad_type</th>
      <th>Ad_location</th>
      <th>is_clicked</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>USA</td>
      <td>Link</td>
      <td>North</td>
      <td>1</td>
    </tr>
    <tr>
      <td>China</td>
      <td>Picture</td>
      <td>East</td>
      <td>1</td>
    </tr>
    <tr>
      <td>China</td>
      <td>Link</td>
      <td>East</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p>其中，Country、Ad_type、Ad_location是特征，is_clicked
是label。这三个特征都是categoricall类型的，所以需要进行one-hot encoding，得到</p>

<table>
  <thead>
    <tr>
      <th>Country=USA</th>
      <th>Country=China</th>
      <th>Ad_type=Link</th>
      <th>Ad_type=Picture</th>
      <th>Ad_location=North</th>
      <th>Ad_location=East</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p>可以看到，现在数据变得非常稀疏，另外，经过one-hot encoding后，特征空间也会变得非常大。</p>

<p>在实际业务中，两个特征组合可能是很有意义的。比如图片广告放在北区用户不太会点（并不一定真实 我的猜想，有种很明显广告的即视感，用户就直接翻下去）</p>

<p>根据上述思路，建立模型：</p>

\[y(x) = w_0 + \sum\limits^n_{i=1}w_ix_i + \sum\limits^n_{i=1}\sum\limits^n_{j=i+1}w_{ij}x_ix_j\]

<p>这里暂时只有特征两两间的关系，两个以上特征组合暂时不讨论，这里的x是已经one-hot后的特征</p>

<p>我们假设特征组合的参数\(w_{ij}\)组成的矩阵为\(W\)，那么它的大小就是\(n\times n\)，这将会非常大</p>

<p>所以FM做的就是将\(W\)进行分解，\(W=VV^T\)，\(V\)可以理解为是特征的隐变量（很像Embedding），\(V\)的大小是\(n\times k\)，\(V\)的第\(j\)行便是第\(j\)维特征的隐变量，所以\(w_{ij} = \left&lt; v_i, v_j \right&gt;\)</p>

<p>而\(k \ll n\)，那么参数的数量就大幅度变少了</p>

<p>那FM的模型为：</p>

\[y(x) = w_0 + \sum\limits^n_{i=1}w_ix_i + \sum\limits^n_{i=1}\sum\limits^n_{j=i+1}\left&lt; v_i, v_j \right&gt;x_ix_j\]

<p>另外，参数因子化使得\(w_{hi}\)和\(w_{ij}\)不再独立，（\(w_{hi} = \left&lt; v_h, v_i \right&gt;\)，\(w_{ij} = \left&lt; v_i, v_j \right&gt;\)</p>

<p>），而在线性模型中它们是独立的</p>

<p>上式的复杂度是\(O(kn^2)\)。但是，上式可以化简为：</p>

\[\sum\limits^n_{i=1}\sum\limits^n_{j=i+1}\left&lt; v_i, v_j \right&gt;x_ix_j = \frac{1}{2}\sum\limits^k_{f=1}\left(\left( \sum\limits^n_{i=1}v_{i,f}x_i \right)^2 - \sum\limits^n_{i=1}v_{i,f}^2x_i^2 \right)\]

<p>这里下标\(f\)代表\(v_i\)的第\(f\)个值，化简后复杂度为\(O(kn)\)，所以FM是种很高效的模型</p>

<p><strong>个人感想</strong>：模型的式子中\(x_ix_j\)其实有很多都是0，实际实现不一定要完全根据式子来，可以用像Embedding那样，直接索引获取隐变量，也就是不将原特征进行one-hot encoding，这样可以省很多时间。</p>

<p>我实现的tensorflow版本：<a href="https://github.com/hahadsg/tensorflow-FM/blob/master/test_fm.ipynb">source</a></p>

<p>我实现的spark版本：<a href="https://github.com/hahadsg/Spark-FM">source</a></p>

<h2 id="ffmfield-factorization-machine">FFM(Field Factorization Machine)</h2>

<p>FFM引入了field概念，将同一个原特征的特征归为同一个field，如：将Country_USA、Country_China归为同一个field。如果有\(f\)个原变量，那么就有\(f\)个field</p>

<p>而\(x_i\)对应的隐变量，从FM的唯一的\(v_i\)，变成FFM的\(v_{i,f_j}\)，\(j\)是跟\(x_i\)组合的另外一个特征，也就是隐变量的数量是之前的\(f\)倍</p>

<p>模型变成：</p>

\[y(x) = w_0 + \sum\limits^n_{i=1}w_ix_i + \sum\limits^n_{i=1}\sum\limits^n_{j=i+1}\left&lt; v_{i,f_j}, v_{j,f_i} \right&gt;x_ix_j\]

<p>不过，FFM的模型没法化简，也就是预测的复杂度为\(O(kn^2)\)</p>

<h2 id="参考">参考</h2>

<p><a href="https://www.csie.ntu.edu.tw/~b97053/paper/Rendle2010FM.pdf">FM paper</a></p>

<p><a href="https://tech.meituan.com/deep-understanding-of-ffm-principles-and-practices.html">美团博客</a></p>

        </section>

        <aside id="sidebar">
          

          

          <p>This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</p>

          <p>由于笔记大部分来自于我之前的gitbook，可能会因为markdown规范不同导致公式显示错误，如果有显示错误请<a href="https://github.com/hahadsg/hahadsg.github.io/issues">找我</a>，感谢</p>
        </aside>
      </div>
    </div>

    
  </body>
</html>
